---
title: TCP 长连接和短连接
top_img: ''
cover: ''
categories: 
    - 八股文
      - 计算机网络
tags: 
    - 计算机网路
---

## TCP 长连接和短连接

### 什么是长连接和短连接

* **长连接（long connnection）**，指在一个连接上可以连续发送多个数据包，在连接保持期间，如果没有数据包发送，需要双方发链路检测包。
* **短连接（short connnection）**，是相对于长连接而言的概念，指的是在数据传送过程中，只在需要发送数据时才去建立一个连接，数据发送完成后则断开此连接，即每次连接只完成一项业务的发送。

<img src="长连接短连接.png" alt="长连接短连接" style="zoom:100%;">

### TCP 长短连接的优势

#### TCP 短连接

* 模拟一下TCP短连接的情况：`client` 向 `server` 发起连接请求，`server` 接到请求，然后双方建立连接。`client` 向 `server` 发送消息，`server` 回应 `client` ，然后一次读写就完成了，这时候双方任何一个都可以发起 `close` 操作，不过一般都是 `client` 先发起 `close` 操作。
* 从上面的描述看，短连接一般只会在 `client/server` 间传递一次读写操作。
* **短连接优点**：管理起来方便，存在的连接都是有效的连接，不需要额外的控制手段。

#### TCP 长连接

* 模拟一下TCP长连接的情况，`client` 向 `server` 发起连接，`server` 接受 `client` 连接，双方建立连接。`Client` 与 `server` 完成一次读写之后，它们之间的连接并不会主动关闭，后续的读写操作会继续使用这个连接。下面介绍一下 TCP 的**保活功能**。
* TCP 的保活功能主要为服务器应用提供。如果客户端已经消失而连接未断开，则会使得服务器上保留一个半开放的连接，而服务器又在等待来自客户端的数据，此时服务器将永远等待客户端的数据。保活功能就是试图在服务端器端检测到这种半开放的连接。
* 如果一个给定的连接在**两小时内**没有任何的动作，则服务器就向客户发一个探测报文段，客户主机必须处于以下 `4` 个状态之一：
  1. **客户主机依然正常运行，并从服务器可达**。客户的 TCP 响应正常，而服务器也知道对方是正常的，服务器在**两小时**后将保证定时器复位。
  2. **客户主机已经崩溃，并且关闭或者正在重新启动**。在任何一种情况下，客户的 TCP 都没有响应。服务端将不能收到对探测的响应，并在 `75秒` 后超时。服务器总共发送 `10` 个这样的探测 ，每个间隔 `75秒` 。如果服务器没有收到一个响应，它就认为客户主机已经关闭并终止连接。
  3. **客户主机崩溃并已经重新启动**。服务器将收到一个对其保证探测的响应，这个响应是一个复位，使得服务器终止这个连接。
  4. **客户机正常运行，但是服务器不可达**。这种情况与 `2` 类似，TCP 能发现的就是没有收到探查的响应。
* 在长连接的应用场景下，client 端一般不会主动关闭它们之间的连接，client 与 server 之间的连接如果一直不关闭的话，会存在一个问题：随着客户端连接越来越多，server 早晚有扛不住的时候，这时候 server 端需要采取一些策略，如关闭一些长时间没有读写事件发生的连接，这样可以避免一些恶意连接导致 server 端服务受损。如果条件再允许就可以以客户端机器为颗粒度，限制每个客户端的最大长连接数，这样可以完全避免某个蛋疼的客户端连累后端服务。

长连接和短连接的产生在于 client 和 server 采取的关闭策略，具体的应用场景采用具体的策略，没有十全十美的选择，只有合适的选择。

### HTTP 与 TCP / IP

* 关于HTTP和TCP/IP各协议的详细介绍：[计算机网络 - 学习总结篇](https://blog.csdn.net/yeahPeng11/article/details/117486184)

#### HTTP 协议与 TCP / IP 协议的关系

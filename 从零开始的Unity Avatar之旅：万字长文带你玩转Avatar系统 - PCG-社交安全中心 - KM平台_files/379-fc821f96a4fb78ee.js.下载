(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[379],{18379:function(e,t,s){"use strict";let n;s.r(t),s.d(t,{__N_SSP:function(){return G},default:function(){return V}});var a=s(11527),l=s(50959),i=s(39017),r=s(22840),o=s(67998),c=s.n(o),d=s(45589),u=s(76283),m=s(34654),_=s(88925),f=s(17571);let v=(0,l.createContext)(void 0);var x=s(34228),p=s(17686),h=s(74637),w=s.n(h),y=s(64708),g=s(32699),b=s.n(g),k=s(8793),j=s.n(k);let N=e=>{let{onSend:t,stopConversationRef:s,textareaRef:n}=e,{t:i}=(0,x.$G)("chat"),{state:{messageIsStreaming:r,userInfo:o}}=(0,l.useContext)(v),[c,d]=(0,l.useState)(""),[u,_]=(0,l.useState)(null),f=e=>{let t=e.target.value;if(t.length>2e3){y.sX.warning("最多支持2000字");return}d(t)},h=()=>{if(r){y.sX.info("回答期间不能提问哦");return}if(!(null==c?void 0:c.trim())){y.sX.info("请输入内容后再发送");return}let e=w()().format("YYYY-MM-DD HH:mm:ss");t({role:"user",content:c.trim(),createdAt:e,user_name:null==o?void 0:o.staffName,answer_type:"text",isFuzzy:0,fuzzyQuestion:[]},u),d(""),_(null)},g=e=>{if(r){y.sX.info("回答期间不能提问哦");return}if(!e.trim()){y.sX.info("请输入内容后再发送");return}let s=w()().format("YYYY-MM-DD HH:mm:ss");t({role:"user",content:e.trim(),createdAt:s,user_name:null==o?void 0:o.staffName,answer_type:"text",isFuzzy:0,fuzzyQuestion:[]},u),d(""),_(null)},k=e=>{if("Enter"===e.key&&229===e.which)return;let t=e.nativeEvent.isComposing;"Enter"!==e.key||t||(0,p.tq)()||e.shiftKey?"/"===e.key&&e.metaKey&&e.preventDefault():(e.preventDefault(),h()),S&&(Y(!0),N())},N=b().debounce(function(){Y(!1)},100);(0,l.useEffect)(()=>{if(n&&n.current){var e,t;n.current.style.height="inherit",n.current.style.height="".concat(Math.max(Math.min(null===(e=n.current)||void 0===e?void 0:e.scrollHeight,100),20),"px"),n.current.style.overflow="".concat((null==n?void 0:null===(t=n.current)||void 0===t?void 0:t.scrollHeight)>100?"auto":"hidden")}},[c,n]);let[z,Y]=(0,l.useState)(!1),[S,D]=(0,l.useState)(!1),C=()=>{D(!0)},E=()=>{D(!1)},M=e=>{switch(e.data.type){case"YST_CHAT_COMP_SEND_QUESTION":if(!e.data.question)break;g(e.data.question)}};return(0,l.useEffect)(()=>(window.addEventListener("message",M),()=>{window.removeEventListener("message",M)}),[t]),(0,a.jsx)("div",{className:"bg-gradient-to-b from-transparent via-white/50 to-white bottom-0 left-0 w-full border-transparent",children:(0,a.jsx)("div",{className:"flex justify-center gap-3 lg:mx-auto lg:max-w-3xl last:mb-[44px] mx-4 mt-0 md:mx-4 ",children:(0,a.jsx)("div",{className:"relative flex w-full flex-grow flex-col rounded-[2px] ".concat(S?"".concat(z?j().colorful_border:j().colorful_border_paused," m-[2px]"):"border rounded-[4px] m-[1px]"," bg-white"),children:(0,a.jsxs)("div",{className:"flex items-center justify-between w-full py-[13px] px-3",children:[(0,a.jsx)("textarea",{ref:n,className:"flex-1 resize-none focus:border-none focus:outline-none focus:shadow-none bg-transparent text-black placeholder:truncate",placeholder:"请输入问题,shift+回车换行,回车发送",value:c,rows:1,onChange:f,onKeyDown:k,onFocus:C,onBlur:E}),(0,a.jsxs)("div",{className:"flex justify-center items-center h-[22px] mt-auto",children:[(0,a.jsx)("span",{className:"p-[4px] text-gy3 pointer-events-none select-none ",children:c.trim().length.toString()+"/2000"}),(0,a.jsx)(m.BF,{className:"".concat(0===c.trim().length||c.trim().length>2e3||r?"cursor-not-allowed":"hover:text-brand2"," flex items-center justify-center rounded-full text-[#B5D1FF] p-0 "),onClick:h,size:27.5})]})]})})})})},z=()=>(0,a.jsxs)("div",{className:"group",style:{overflowWrap:"anywhere"},children:[(0,a.jsx)("div",{className:"relative m-auto flex py-2 px-4 w-full gap-2 md:gap-3 lg:gap-6 lg:max-w-3xl lg:px-0",children:(0,a.jsx)("div",{className:"relative w-fit rounded-md rounded-tl-[3px] bg-gray-50 px-4 py-2",style:{color:"transport"},children:(0,a.jsx)("div",{className:"loading bkg-transport-colorful font-semibold",children:"小G正在思考中"})})}),(0,a.jsx)("style",{children:"\n          .loading::after {\n            display: inline-block;\n            animation: dotty steps(1, end) 1s infinite;\n            content: '';\n          }\n\n          @keyframes dotty {\n            0%   { content: ''; }\n            25%  { content: '.'; }\n            50%  { content: '..'; }\n            75%  { content: '...'; }\n            100% { content: ''; }\n          }\n\n          .bkg-transport-colorful {\n            background: linear-gradient(\n              45deg,\n              #61ADFF,\n              #358FFC,\n              #20E592,\n              #FE8E03,\n              #61ADFF,\n              #358FFC,\n              #20E592,\n              #FE8E03\n            );\n            background-size: 400%;\n            animation: animate 20s linear infinite;\n            background-clip: text !important;\n            -webkit-background-clip: text;\n            color: rgba(0, 0, 0, 0.2);\n          }\n          \n          @keyframes animate {\n            0% {\n              background-position: 0 0;\n            }\n            50% {\n              background-position: 400% 0;\n            }\n            100% {\n              background-position: 0 0;\n            }\n          }\n        "})]});var Y=s(55630),S=s(74160),D=s(92224),C=s(29383),E=s(18949),M=s(90452),F=s(25889),H=s(50723),I=s(51609);let A=(0,l.forwardRef)((e,t)=>{let{setIsEvaluating:s,setMessageScore:n,msg_id:i}=e,{state:{isTry:r}}=(0,l.useContext)(v),[o,c]=(0,l.useState)(!1),{FormItem:d}=F.l,[m,_]=(0,l.useState)([]),[f,x]=(0,l.useState)(!0),{webSiteChatFeedback:p}=(0,u.Z)(),h=async()=>{if(0===m.length){y.sX.warning("请至少选择一个选项");return}if(!r)try{await p({msg_id:i,helpful:!1,answer_feedback:m})}catch(e){console.log("评价接口调用失败"+e),s(!1)}y.sX.success("感谢您的帮助~"),s(!1),n(-1),_([]),c(!1)};return(0,l.useImperativeHandle)(t,()=>({show(){_([]),c(!0)}})),(0,a.jsx)(a.Fragment,{children:(0,a.jsx)(H.Vq,{visible:o,header:"对答案不满意？帮助我改进下吧！",theme:"info",cancelBtn:null,onClose:()=>{s(!1),c(!1)},confirmBtn:{content:"确认",disabled:f},onConfirm:()=>h(),destroyOnClose:!0,children:(0,a.jsx)(F.l,{labelAlign:"top",children:(0,a.jsx)(d,{label:"您觉得答案有什么问题？",rules:[{required:!0}],children:(0,a.jsx)(I.X.Group,{value:m,onChange:e=>{_(e),x(0===e.length)},options:[{value:"答案与问题无关",label:"答案与问题无关"},{value:"答案缺少关键信息",label:"答案缺少关键信息"},{value:"答案太简单了",label:"答案太简单了"},{value:"其他",label:"其他"}],style:{flexDirection:"column"}})})})})})});var R=s(54329),q=s.n(R);let Q=()=>{if(!location.host)return null;if(location.host.includes("yst-test.woa.com"));else if(location.host.includes("yst-beta.woa.com"))return"0WEB0HNTRW4I8CTU";else if(location.host.includes("yst.woa.com"))return"0WEB0V4J0742LBRX";return"0WEB0G8J074CLZQT"},X=e=>{console.log("onReportSuccess: ",e)},B=e=>{console.log("onReportFail: "+e)},T=new Map([["visit_help_center",!1]]),O=(e,t)=>{window.__beacon__&&!0!==T.get(e)&&(window.__beacon__.onUserAction(e,t),!1===T.get(e)&&T.set(e,!0))};var U=s(71343);function W(e){let{data:t}=e,s=(0,l.useRef)(null);return(0,a.jsx)(a.Fragment,{children:(0,a.jsx)("div",{children:(()=>{if("image"===t.type){var e;return(0,a.jsx)("div",{children:(0,a.jsx)("div",{style:{position:"relative",paddingRight:"20px",display:"inline-block"},children:null!==(e=t.content)&&void 0!==e?e:(0,a.jsx)(U.E,{src:t.content,fit:"fill",style:{cursor:"pointer"},ref:s})})})}return"link"===t.type&&t.link?(0,a.jsx)("a",{style:{color:"#0052D9",cursor:"pointer"},href:t.link.key,target:"_blank",children:t.link.text}):"text"===t.type?"string"==typeof t.content?(0,a.jsx)("div",{children:t.content}):t.text&&t.text.content?(0,a.jsx)("div",{children:t.text.content}):(t.content||[]).map((e,t)=>(0,a.jsx)("div",{children:(0,a.jsx)(W,{data:e})},t)):void 0})()})})}let P=(0,l.memo)(e=>{var t,s,n,i;let{messageIndex:r,onSend:o}=e,{state:{messageIsStreaming:c,messages:d,loading:_,userInfo:f,webSiteDetail:x,webKey:p,visitKey:h,isTry:g,sessionId:b}}=(0,l.useContext)(v),k=d[r],[j,N]=(0,l.useState)(k.content),[z,F]=(0,l.useState)(k.score),[H,I]=(0,l.useState)(!1),[R,q]=(0,l.useState)("/chat/assets/images/model/default.svg"),[Q,X]=(0,l.useState)(!1),{evaluteMessage:B,upFlow:T,webSiteChatFeedback:U,projectIDByServiceID:P}=(0,u.Z)(),Z=null!==(s=d[r-1])&&void 0!==s?s:null,K=!Z&&k.createdAt||(null==Z?void 0:Z.createdAt)&&k.createdAt&&Math.abs(w()(Z.createdAt).valueOf()-w()(k.createdAt).valueOf())>3e5,L=null!==(n=k.showSwitchConversation)&&void 0!==n&&n,J=async e=>{if(null==x?void 0:x.service_id){if(0===x.service_shunt_prod_id){let{prod_id:t}=await P({service_id:x.service_id});e.prod_id=t}else e.prod_id=x.service_shunt_prod_id;e.proj_id=x.service_proj_id,e.data.push({key:"service_id",value:x.service_id})}return e},G=async()=>{if(!navigator.clipboard)return;if(!g){O("copy_content",{user_name:null==f?void 0:f.staffName,copy_time:Date.now(),web_name:null==x?void 0:x.name,answer_id:k.content_id,visit_id:"".concat(null==f?void 0:f.staffName,"_").concat(h),web_key:p});let e={flow_type:"web_site_action",data:[{key:"msg_type",value:"click"},{key:"content",value:"web_site_click_copy"},{key:"username",value:null==f?void 0:f.staffName},{key:"event_time",value:w()().format("YYYY-MM-DD HH:mm:ss")},{key:"session_id",value:b},{key:"channel",value:"web_site"},{key:"web_name",value:null==x?void 0:x.name},{key:"web_key",value:p},{key:"msg_id",value:k.content_id}]};T(await J(e))}let e=k.recall_docs&&k.recall_docs.length>0?k.recall_docs.reduce((e,t,s,n)=>e+"".concat(s+1,".[").concat(t.title,"](").concat(t.url,");"),"".concat(k.content,"\n")):"".concat(k.content,"\n");navigator.clipboard.writeText(e).then(()=>{I(!0),setTimeout(()=>{I(!1)},2e3)}),y.sX.success("复制成功，快去分享吧～")};(0,l.useEffect)(()=>{N(k.content)},[k.content]);let V=async()=>{if(!Q&&1!==z){if(!g){O("click_like",{user_name:null==f?void 0:f.staffName,click_time:Date.now(),web_name:null==x?void 0:x.name,answer_id:k.content_id,visit_id:"".concat(null==f?void 0:f.staffName,"_").concat(h),web_key:p});let e={flow_type:"web_site_action",data:[{key:"msg_type",value:"click"},{key:"content",value:"web_site_click_helpful"},{key:"username",value:null==f?void 0:f.staffName},{key:"event_time",value:w()().format("YYYY-MM-DD HH:mm:ss")},{key:"session_id",value:b},{key:"channel",value:"web_site"},{key:"web_name",value:null==x?void 0:x.name},{key:"web_key",value:p},{key:"msg_id",value:k.content_id}]};T(await J(e))}if(X(!0),!g)try{await U({msg_id:k.content_id,helpful:!0,answer_feedback:[]})}catch(e){console.log("评价接口调用失败"+e),X(!1)}y.sX.success("感谢您的认可～"),X(!1),F(1)}},$=(0,l.useRef)(),ee=async()=>{if($.current&&-1!==z){if(!g){O("click_dislike",{user_name:null==f?void 0:f.staffName,click_time:Date.now(),web_name:null==x?void 0:x.name,answer_id:k.content_id,visit_id:"".concat(null==f?void 0:f.staffName,"_").concat(h),web_key:p});let e={flow_type:"web_site_action",data:[{key:"msg_type",value:"click"},{key:"content",value:"web_site_click_no_helpful"},{key:"username",value:null==f?void 0:f.staffName},{key:"event_time",value:w()().format("YYYY-MM-DD HH:mm:ss")},{key:"session_id",value:b},{key:"channel",value:"web_site"},{key:"web_name",value:null==x?void 0:x.name},{key:"web_key",value:p},{key:"msg_id",value:k.content_id}]};T(await J(e))}$.current.show()}},[et,es]=(0,l.useState)(!0),en=()=>{es(!et)},ea=e=>{window.open(e,"_blank"),window.parent.postMessage({type:"yst_open_url",url:e},"*")},el=e=>{if(c)return;let t=w()().format("YYYY-MM-DD HH:mm:ss");o({role:"user",content:e.trim(),createdAt:t,user_name:null==f?void 0:f.staffName,answer_type:"text",isFuzzy:0,fuzzyQuestion:[]},null)};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(A,{ref:$,setIsEvaluating:X,setMessageScore:F,msg_id:k.content_id}),K&&(0,a.jsx)("div",{className:"flex justify-center pt-1",children:(0,a.jsx)("div",{className:"text-xs text-gray-500 text-center rounded px-2 py-1 bg-gray-100",children:k.createdAt&&(0,S.i)(k.createdAt)})}),(0,a.jsx)("div",{className:"group",style:{overflowWrap:"anywhere"},children:(0,a.jsx)("div",{className:"relative m-auto flex ".concat("user"===k.role&&"justify-end"," p-4 text-base w-full gap-2 md:gap-3 lg:gap-6 lg:max-w-3xl lg:px-0"),children:(0,a.jsxs)("div",{className:"flex-col max-w-full",children:["user"===k.role?(0,a.jsx)("div",{className:"flex-0 flex items-center relative rounded-md bg-[#D9E8FF] px-4 py-2",children:(0,a.jsx)("div",{className:"prose text-default max-w-full whitespace-pre-wrap dark:prose-invert flex-1 text-sm md:text-base",children:k.content})}):"system"===k.role?(0,a.jsx)("div",{className:"flex-0 flex items-center relative rounded-md bg-[#F1F2F5] px-4 py-2",children:(0,a.jsx)("div",{className:"prose text-default max-w-full whitespace-pre-wrap dark:prose-invert flex-1 text-gray-800 text-sm md:text-base",children:k.content})}):(0,a.jsx)("div",{className:"flex-1 relative w-full rounded-md bg-[#F1F2F5] px-3 py-[9px] shadow-[0_1px_10px_rgba(8,26,81,0.05)]",children:(0,a.jsxs)("div",{className:"flex flex-col",children:[!k.isError&&k.recall_docs&&k.recall_docs.length>0&&(0,a.jsxs)("div",{className:"text-sm border-b border-gray-200 mb-2 py-2 pt-0 leading-4 flex flex-col justify-between",children:[(0,a.jsxs)("div",{className:"text-default font-semibold flex flex-row items-center justify-between",children:[(0,a.jsxs)("div",{children:["基于 ",k.recall_docs.length," 个参考文档"]}),(0,a.jsx)(m.ZP,{className:"".concat(et?"rotate-0":"rotate-180"," transition-all ease-linear delay-100 hover:text-brand2 cursor-pointer"),size:14,name:"chevron-down",onClick:en})]}),(0,a.jsx)("div",{className:"".concat(et?"max-h-[1000px] mt-2":"max-h-0"," transition-all ease-in-out delay-100 overflow-hidden flex flex-col gap-1"),children:k.recall_docs.map((e,t)=>(0,a.jsxs)("div",{className:"flex flex-row items-center gap-[8px] cursor-pointer w-fit",onClick:()=>ea(e.url),children:[(0,a.jsx)(m.ZP,{size:14,name:"link",className:"text-brand2"}),(0,a.jsx)("div",{className:"w-fit text-brand2 py-1",children:e.title},t)]},t))})]}),1===k.isFuzzy&&(null===(t=k.fuzzyQuestion)||void 0===t?void 0:t.length)>0?(0,a.jsxs)("div",{className:"html_message max-w-full flex-1 w-full text-sm text-default overflow-hidden text-ellipsis ".concat(k.isError&&"text-red-500 font-bold"),children:[(0,a.jsx)("div",{className:"mb-[20px]",children:"您是不是想咨询以下问题？请点击选择"}),k.fuzzyQuestion.map((e,t)=>(0,a.jsx)(a.Fragment,{children:(0,a.jsx)("div",{className:"text-brand2 ".concat(c?"cursor-not-allowed":"cursor-pointer"," whitespace-nowrap max-w-full overflow-hidden text-ellipsis"),onClick:()=>el(e),children:"".concat(t+1,".").concat(e)},"".concat(e,"_").concat(t))}))]}):"html"===k.answer_type?(0,a.jsx)("div",{className:"html_message max-w-full flex-1 w-full text-sm text-default ".concat(k.isError&&"text-red-500 font-bold"),children:(0,a.jsx)("p",{dangerouslySetInnerHTML:{__html:k.content}})}):"rich_text"===k.answer_type?(0,a.jsx)("div",{className:"html_message max-w-full flex-1 w-full text-sm text-default ".concat(k.isError&&"text-red-500 font-bold"),children:(JSON.parse(k.content)||[]).map((e,t)=>(0,a.jsx)(W,{data:e},t))}):(0,a.jsx)(C.s,{className:"prose text-default max-w-full dark:prose-invert flex-1 w-full text-sm text-default",remarkPlugins:[M.Z],rehypePlugins:[E.Z],components:{code(e){let{node:t,inline:s,className:n,children:l,...i}=e;if(l.length){if("▍"==l[0])return(0,a.jsx)("span",{className:"animate-pulse cursor-default mt-1 text-gray-600",style:{animationDuration:"0.7s"},children:"▍"});l[0]=l[0].replace("`▍`","▍")}let r=/language-(\w+)/.exec(n||"");return s?(0,a.jsx)("code",{className:n,...i,children:l}):(0,a.jsx)(D.d,{canCopy:!0,language:r&&r[1]||"",value:String(l).replace(/\n$/,""),...i},Math.random())},table(e){let{children:t}=e;return(0,a.jsx)("table",{className:"border-collapse border border-black px-3 py-1 dark:border-white",children:t})},th(e){let{children:t}=e;return(0,a.jsx)("th",{className:"break-words border border-black bg-gray-500 px-3 py-1 text-white dark:border-white",children:t})},td(e){let{children:t}=e;return(0,a.jsx)("td",{className:"break-words border border-black px-3 py-1 dark:border-white",children:t})},a(e){let{href:t,children:s}=e,n="",l=[];return t&&t.includes("%5C")&&(n=decodeURIComponent(t).replace(/\n/g,"_")),(null==s?void 0:s.length)&&"string"==typeof s[0]&&s[0].includes("\\_")?l=s[0].replace(/\n/g,"_"):(n=t,l=s),(0,a.jsx)("a",{className:"text-brand2",target:"_blank",href:n,children:l})}},children:"".concat(k.content).concat(c&&r==(null!==(i=d.length)&&void 0!==i?i:0)-1?"`▍`":"")}),k.commonQuestion&&k.commonQuestion.length>0&&(0,a.jsx)("div",{className:"mt-[20px]",children:k.commonQuestion.map((e,t)=>(0,a.jsx)("div",{className:"text-[14px] text-brand2 cursor-pointer",onClick:()=>el(e),children:e},"".concat(e,"_").concat(t)))})]})}),!c&&!_&&"assistant"===k.role&&!k.isError&&(0,a.jsxs)("div",{className:"hidden group-hover:flex absolute bottom-[-16px] left-[12px] px-2 py-1 flex item-center justify-center gap-2 bg-white",children:[H?(0,a.jsx)("button",{children:(0,a.jsx)(Y.Z,{size:20,className:"text-brand2 dark:text-brand2",name:"icon-check-circle-filled"})}):(0,a.jsx)("button",{className:"text-gray-500 hover:text-brand2 dark:text-gray-400 dark:hover:text-brand2",onClick:G,children:(0,a.jsx)(m.vU,{className:"hover:fill-brand2",size:20})}),(0,a.jsx)("button",{className:"text-gray-500 hover:text-default dark:text-gray-400 dark:hover:text-gray-300",onClick:()=>V(),children:1===z?(0,a.jsx)(m.$I,{className:"fill-brand2",size:20}):(0,a.jsx)(m.tF,{className:"hover:fill-brand2",size:20})}),(0,a.jsx)("button",{className:"text-gray-500 hover:text-default dark:text-gray-400 dark:hover:text-gray-300",onClick:()=>ee(),children:-1===z?(0,a.jsx)(m.Jn,{className:"fill-brand2",size:20}):(0,a.jsx)(m.zL,{className:"hover:fill-brand2",size:20})})]})]})})}),L&&(0,a.jsx)("div",{className:"flex justify-center py-3",children:(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("div",{className:"absolute top-1/2 left-1/2  h-px w-[140%] -translate-x-1/2 bg-black/10"}),(0,a.jsx)("div",{className:"relative text-xs text-gray-500 text-center rounded px-2 py-1 bg-white",children:"以下是新对话"})]})})]})});P.displayName="ChatMessage";var Z=s(63762);let K=(0,l.memo)(e=>{let{stopConversationRef:t}=e,s=(0,_.i)(),{state:{loading:i,webKey:o,webSiteDetail:c,messages:d,isTry:x,showServiceEntry:p,showWelcome:h,welcomeMessage:g,userInfo:b,visitKey:k,sessionId:j},dispatch:Y}=(0,l.useContext)(v),S=(0,r.useRouter)(),{projectIDByServiceID:D,webSiteChat:C,getWebSiteChatList:E,creatAgentGroupSession:M,manualRepSessionJudge:F,getServiceDetailById:I,createWebSiteSession:A,sendEnterChatServiceMsg:R,checkWebSiteSession:q,upFlow:Q}=(0,u.Z)(),[X,B]=(0,l.useState)(!0),[T,U]=(0,l.useState)(!1),W=(0,l.useRef)(null),K=(0,l.useRef)(null),L=(0,l.useRef)(null),J=(0,l.useRef)(null),[G,V]=(0,l.useState)(""),[$,ee]=(0,l.useState)("");(0,l.useEffect)(()=>{V("https://".concat(location.host,"/robot/userModelDetail?id=").concat(null==c?void 0:c.model_id)),ee("https://".concat(location.host,"/robot/market"))},[c]);let et=async()=>{let e;if(!o)return;let t=!1;if(j){let e=await q({web_key:o,session_id:j});t=e.valid}if(!j||!t){try{let t=await A({web_key:o});e=t.session_id}catch(t){try{let t=await A({web_key:o});e=t.session_id}catch(t){try{let t=await A({web_key:o});e=t.session_id}catch(e){console.log("error",e)}}}Y({field:"sessionId",value:e})}return e||j},es=async e=>{let t=[];if(o){let e=[];try{let{data:t}=await E({web_key:o,create_at:[w()().subtract(3,"month").format("YYYY-MM-DD HH:mm:ss"),w()().format("YYYY-MM-DD HH:mm:ss")]});t.reverse(),e=[...t]}catch(e){console.log("获取消息记录失败: "+e)}for(let o=0;o<e.length;o++){var s,n,a,l,i,r,c,d,u,m,_,f,v,x,p,h;t.push(...[{content_id:null===(s=e[o])||void 0===s?void 0:s.msg_id,session_id:null===(n=e[o])||void 0===n?void 0:n.msg_id,role:"user",content:null===(a=e[o])||void 0===a?void 0:a.question,createdAt:null===(l=e[o])||void 0===l?void 0:l.create_at,user_name:null===(i=e[o])||void 0===i?void 0:i.user_name},{content_id:null===(r=e[o])||void 0===r?void 0:r.msg_id,session_id:null===(c=e[o])||void 0===c?void 0:c.msg_id,role:"assistant",content:null===(d=e[o])||void 0===d?void 0:d.answer.replace(/\n/g,"  \n"),createdAt:null===(u=e[o])||void 0===u?void 0:u.create_at,isError:!(null===(m=e[o])||void 0===m?void 0:m.is_ask_success),score:null===(_=e[o])||void 0===_?void 0:_.feed_back_status,answer_type:null===(f=e[o])||void 0===f?void 0:f.answer_type,recall_docs:(null===(v=e[o])||void 0===v?void 0:v.recall_docs_for_report)?JSON.parse(null===(x=e[o])||void 0===x?void 0:x.recall_docs_for_report):[],isFuzzy:(null===(p=e[o])||void 0===p?void 0:p.is_fuzzy)||0,fuzzyQuestion:(null===(h=e[o])||void 0===h?void 0:h.fuzzy_question)||[]}])}}Y({field:"messages",value:t=e(t)})},en=e=>{let t=[...e],s=t[t.length-1];if(h){let e={showSwitchConversation:!1,content_id:"000",session_id:"000",role:"assistant",content:g,createdAt:w()().format("YYYY-MM-DD HH:mm:ss"),isError:!0,answer_type:"text",user_name:"agent",isFuzzy:0,fuzzyQuestion:[],commonQuestion:(null==c?void 0:c.common_question)||[]};0===t.length||"000"!==s.content_id?t.push(e):"000"===s.content_id&&(t[t.length-1]=e)}else t.length>0&&"000"===s.content_id&&t.pop();return t},[ea,el]=(0,l.useState)(!1),ei=async()=>{el(!0),await et(),await es(en),el(!1)};(0,l.useEffect)(()=>{ei()},[o,h,g]);let er=(0,l.useCallback)(async e=>{if(o&&c||x){Y({field:"loading",value:!0}),Y({field:"messageIsStreaming",value:!0}),Y({field:"messages",value:[...d,e]}),ed(!0);try{let s=await et(),a={session_id:s,is_try:x,web_key:o,business_key:c.business_key,question:e.content};if(t.current=new AbortController,null==c?void 0:c.supportStream){let a=!0;(n=new EventSource("/servicedesk-api/trpc.servicedesk.yuanfang_service.YuanFangService/WebSiteStreamChat?is_try=".concat(x,"&web_key=").concat(o,"&business_key=").concat(c.business_key,"&question=").concat(encodeURIComponent(e.content),"&session_id=").concat(s))).onerror=s=>{let a={role:"assistant",content:"请求出错请稍后再试",createdAt:w()().format("YYYY-MM-DD HH:mm:ss"),isError:!0,answer_type:"text",isFuzzy:0,fuzzyQuestion:[]},l=[...d,e,a];Y({field:"loading",value:!1}),Y({field:"messageIsStreaming",value:!1}),Y({field:"messages",value:l}),t.current=null,null==n||n.close(),ed(!0)};let l="";n.addEventListener("delta",s=>{let i=JSON.parse(s.data),r=i.finished,u=1===i.global_output.answer_success,m=i.response,_=i.global_output.docs||[],f=i.msg_id,v=i.is_fuzzy||0,p=i.fuzzy_question||[];if(r&&!u){if(a){let t={session_id:Date.now().toString(),content_id:Date.now().toString(),content:"哎呀，答案迷路啦，请稍后再试～",role:"assistant",createdAt:w()().format("YYYY-MM-DD HH:mm:ss"),score:0,isError:!0,answer_type:"markdown",user_name:"unknown",recall_docs:[],isFuzzy:0,fuzzyQuestion:[]};Y({field:"messages",value:[...d,e,t]})}else{let e=d.map((e,t)=>t===d.length-1?{...e,isError:!0,content:"哎呀，答案迷路啦，请稍后再试～"}:e);Y({field:"messages",value:e})}}if(a){a=!1,l=m.replace(/\n/g,"  \n");let t={content_id:f||"streaming",session_id:f||"streaming",role:"assistant",isError:!1,answer_type:"markdown",content:l,createdAt:w()().format("YYYY-MM-DD HH:mm:ss"),recall_docs:_,isFuzzy:v,fuzzyQuestion:p};Y({field:"loading",value:!1}),Y({field:"messages",value:[...d,e,t]})}else{l+=m.replace(/\n/g,"  \n");let t={content_id:f||"streaming",session_id:f||"streaming",role:"assistant",isError:!1,answer_type:"markdown",content:l,createdAt:w()().format("YYYY-MM-DD HH:mm:ss"),recall_docs:_,isFuzzy:v,fuzzyQuestion:p};Y({field:"messages",value:[...d,e,t]}),r&&!x&&O("ask_question",{user_name:null==b?void 0:b.staffName,ask_time:Date.now(),web_name:null==c?void 0:c.name,visit_id:"".concat(null==b?void 0:b.staffName,"_").concat(k),web_key:o})}r&&(Y({field:"loading",value:!1}),Y({field:"messageIsStreaming",value:!1}),t.current=null,null==n||n.close()),ed(!0)})}else{let{data:s}=await C(a,t.current.signal);t.current=null;let n={content_id:s.msg_id,session_id:s.msg_id,role:"assistant",content:s.answer.replace(/\n/g,"\n\n"),createdAt:w()().format("YYYY-MM-DD HH:mm:ss"),score:0,isError:!s.is_ask_success,answer_type:s.answer_type,user_name:s.user_name,recall_docs:s.recall_docs_for_report?JSON.parse(s.recall_docs_for_report):[],isFuzzy:s.is_fuzzy||0,fuzzyQuestion:s.fuzzy_question||[]};Y({field:"loading",value:!1}),Y({field:"messageIsStreaming",value:!1});let l=[...d,e,n];Y({field:"messages",value:l}),ed(!0),x||O("ask_question",{user_name:null==b?void 0:b.staffName,ask_time:Date.now(),web_name:null==c?void 0:c.name,visit_id:"".concat(null==b?void 0:b.staffName,"_").concat(k),web_key:o})}}catch(a){t.current=null;let s=a.msg||"请求出错请稍后再试";a.code&&(s+="\n```json\n".concat(JSON.stringify(a,null,2),"\n```")),"AbortError"===a.name&&(s="我已停止回答，你可以向我提问其他问题。");let n={content_id:"error_".concat(Date.now()),session_id:"error_".concat(Date.now()),role:"assistant",content:s,createdAt:w()().format("YYYY-MM-DD HH:mm:ss"),isError:!0,answer_type:"text",isFuzzy:0,fuzzyQuestion:[]};Y({field:"loading",value:!1}),Y({field:"messageIsStreaming",value:!1}),Y({field:"messages",value:[...d,e,n]}),ed(!0)}}},[d,o,c,x,s,Y,t]),eo=()=>{if(L.current){let{scrollTop:e,scrollHeight:t,clientHeight:s}=L.current;e+s<t-30?(B(!1),U(!0)):(B(!0),U(!1))}},ec=e=>{if(X||e){var t;null===(t=K.current)||void 0===t||t.scrollIntoView(!1)}},ed=(0,f.P)(ec,250);(0,l.useEffect)(()=>{ed()},[d,ed]);let eu=async e=>{if(null==c?void 0:c.service_id){if(0===c.service_shunt_prod_id){let{prod_id:t}=await D({service_id:c.service_id});e.prod_id="".concat(t)}else e.prod_id=c.service_shunt_prod_id;e.proj_id=c.service_proj_id,e.data.push({key:"service_id",value:c.service_id})}return e},[em,e_]=(0,l.useState)(!1),ef=async()=>{if(!o&&!x||!c||!c.service_proj_id||!c.service_id||em)return;if(!x){O("click_helper_service",{user_name:null==b?void 0:b.staffName,click_time:Date.now(),web_name:null==c?void 0:c.name,visit_id:"".concat(null==b?void 0:b.staffName,"_").concat(k),web_key:o});let e={flow_type:"web_site_action",data:[{key:"msg_type",value:"click"},{key:"content",value:"web_site_click_manual"},{key:"username",value:null==b?void 0:b.staffName},{key:"event_time",value:w()().format("YYYY-MM-DD HH:mm:ss")},{key:"session_id",value:j},{key:"channel",value:"web_site"},{key:"web_name",value:null==c?void 0:c.name},{key:"web_key",value:o}]};Q(await eu(e))}e_(!0);let{is_duplicate:e,data:t}=await F({proj_id:c.service_proj_id,service_id:c.service_id});if(e_(!1),e){let{data:{service_list:e}}=await I({service_id:c.service_id}),s=(0,H.AL)({header:"已存在与客服号的会话，是否需要发起新的咨询？",body:(0,a.jsx)(a.Fragment,{children:(0,a.jsxs)("div",{children:[e&&e.length>0&&(0,a.jsxs)("p",{children:["\xb7客服号：",(0,a.jsx)("a",{className:"cursor-pointer text-brand2",onClick:()=>{e[0].service_id?window.location.href="wxwork://openconversation?userid=".concat(e[0].service_id):y.sX.error("缺少service_id")},children:e[0].service_name})]}),t.group_chat&&t.group_chat.length>0&&(0,a.jsx)("p",{children:"\xb7群聊会话："}),(0,a.jsx)("div",{className:"max-h-[66px] overflow-y-scroll",children:t.group_chat&&t.group_chat.map(e=>(0,a.jsx)(a.Fragment,{children:(0,a.jsx)("p",{children:(0,a.jsx)("a",{className:"cursor-pointer text-brand2",onClick:()=>{window.location.href="wxwork://openconversation?roomid=".concat(e.group_id.replace("ww",""))},children:e.group_name})})}))})]})}),onCancel:()=>{s.destroy()},confirmBtn:"发起新的咨询",onConfirm:()=>{ev(),s.destroy()},onCloseBtnClick:()=>{s.destroy()}})}else await ev()},ev=async()=>{if((o||x)&&c&&c.service_proj_id&&c.service_id){if(c.service_to_agent){let e;let t={web_name:c.name,business_key:c.business_key,proj_id:c.service_proj_id,service_id:c.service_id};o&&(t.web_key=o),c.service_shunt_prod_id&&(t.shunt_prod_id=c.service_shunt_prod_id),j&&(t.session_id=j);try{let s=await M(t);e=s.data}catch(e){console.log("获取拉群接口失败:"+e)}e&&(y.sX.success("已为你拉起客服号"),window.location.href="wxwork://openconversation?roomid=".concat(e.chat_id.replace("ww","")))}else{y.sX.success("已为你拉起客服号");let e=await et();e&&o&&await R({web_key:o,service_id:c.service_id,session_id:e}),window.location.href="wxwork://openconversation?userid=".concat(c.service_id)}}};return(0,a.jsxs)("div",{className:"relative h-full flex flex-col flex-1 overflow-hidden bg-white",children:[(0,a.jsx)(Z.gb,{loading:ea,fullscreen:!0,preventScrollThrough:!0,text:"加载中"}),(0,a.jsxs)("div",{className:"flex flex-col flex-auto overflow-y-auto justify-between h-full",children:["1"!==S.query.hide_header&&(0,a.jsxs)("div",{className:"border-b border-solid border-gy2 sticky top-0 flex items-center p-[16px] text-[16px] font-semibold text-black z-30 bg-white",children:[(null==c?void 0:c.icon)?(0,a.jsx)("img",{src:c.icon,className:"object-contain min-w-[56px] h-[56px] max-w-[80px]"}):(0,a.jsx)(m.YY,{size:80}),(0,a.jsxs)("div",{className:"h-[56px] flex flex-col ml-[12px] items-start justify-end",children:[(0,a.jsx)("span",{className:"font-medium",children:(null==c?void 0:c.title)||"小G(智能问答)"}),(null==c?void 0:c.description)?(0,a.jsx)("span",{className:"text-[12px] font-normal text-[#00000066]",children:null==c?void 0:c.description}):(0,a.jsx)("span",{className:"h-[20px] w-[1px]",children:" "})]})]}),(0,a.jsxs)("div",{className:"flex-1 max-h-full overflow-x-hidden grow",ref:L,onScroll:eo,children:[(0,a.jsx)("div",{className:"h-[8px] lg:h-[80px]",ref:W}),d&&d.map((e,t)=>(0,a.jsx)(P,{messageIndex:t,onSend:e=>{er(e)}},"".concat(e.content_id||0,"_").concat(t))),i&&(0,a.jsx)(z,{}),(0,a.jsx)("div",{className:"h-[16px]",ref:K})]}),(0,a.jsx)(N,{stopConversationRef:t,textareaRef:J,onSend:e=>{er(e)}})]}),(0,a.jsxs)("div",{className:"z-50 absolute w-full left-0 bottom-0 text-xs text-gy5 pointer-events-none flex flex-row justify-between px-4 py-3",children:[(0,a.jsxs)("div",{children:["AI能力由",(0,a.jsx)("a",{href:G,target:"_blank",className:"text-brand2 pointer-events-auto",children:null==c?void 0:c.chn_name}),"提供｜由",(0,a.jsx)("a",{className:"text-brand2 pointer-events-auto",href:$,target:"_blank",children:"易事厅"}),"提供技术支持"]}),p&&(0,a.jsxs)("div",{className:"block flex h-[14px] w-fit items-center justify-center rounded-md bg-white text-gray-500 cursor-pointer pointer-events-auto",onClick:ef,children:[em?(0,a.jsx)("div",{className:"m-1 h-4 w-4 animate-spin rounded-full border-t-2 border-neutral-800 opacity-60"}):(0,a.jsx)(m.vE,{}),(0,a.jsx)("span",{className:"ml-1 text-brand2",children:"咨询客服号"})]})]})]})});K.displayName="Chat";let L={visitKey:Date.now(),sessionId:void 0,isTry:!1,userInfo:void 0,loading:!1,lightMode:"light",messageIsStreaming:!1,messageError:!1,webKey:void 0,webSiteDetail:void 0,messages:[],showChatHeader:!0,chatHeaderTitle:"聊天小组件",showWelcome:!1,welcomeMessage:"",serviceToAgent:!1,showServiceEntry:!0},J=e=>{let{}=e,t=(0,r.useRouter)(),{getUserInfo:s,getWebSiteDetail:n,getRobotInstanceDetailByBusinessKey:o,getModelDetailById:m}=(0,u.Z)(),_=(0,d.L)({initialState:L}),{state:{webKey:f,webSiteDetail:x,visitKey:p},dispatch:h}=_;(0,l.useEffect)(()=>{!function(){if(window.__beacon__)return;let e=Q();if(!e){console.log("Beacon init error: appKey is null");return}try{let t=new(q())({appkey:e,strictMode:!1,delay:1e3,onReportSuccess:X,onReportFail:B,needQueryConfig:!1});window.__beacon__=t}catch(e){console.error("Beacon init error:",e)}}()});let w=async()=>{let{is_try:e,web_key:s}=t.query;if(s&&h({field:"webKey",value:s}),h({field:"isTry",value:"true"===e}),!s&&"false"===e){y.sX.error("未获取到WebKey，请尝试刷新");return}let a={id:0,web_key:"",business_key:"",name:"",remarks:"",title:"",welcome_msg:"",service_enabled:!1,service_proj_id:0,service_id:"",service_shunt_prod_id:0,creat_at:"",update_at:"",creator:"",modifier:"",service_to_agent:!1,chn_name:"未知模型",model_id:0,supportStream:!1,icon:"",description:"",common_question:[]};if("true"===e){let{name:e,title:s,welcome_msg:n,service_enabled:l,proj_id:i,service_id:r,shunt_prod_id:o,business_key:c,service_to_agent:d,icon:u,description:m,common_question:_}=t.query;a.name=decodeURIComponent(e),a.title=decodeURIComponent(s),a.welcome_msg=decodeURIComponent(n),a.service_enabled="true"===l,a.service_proj_id=parseFloat(i),a.service_id=r,a.service_shunt_prod_id=parseFloat(o),a.business_key=c,a.service_to_agent="true"===d,a.icon=decodeURIComponent(u),a.description=m,a.common_question="string"==typeof _?[_]:_}else try{let e=await n(s);a=e.data}catch(e){y.sX.error("获取组件详情失败，请尝试刷新")}if(a.business_key){let e=await o({business_key:a.business_key});a.model_id=e.data.model_id;let t=await m({model_id:e.data.model_id});a.chn_name=t.data.chn_name,a.supportStream=t.data.support_scenario.includes("stream_output")}if(a){let e=a;h({field:"showWelcome",value:!!e.welcome_msg}),h({field:"welcomeMessage",value:e.welcome_msg}),h({field:"showServiceEntry",value:e.service_enabled}),h({field:"webSiteDetail",value:e})}};(0,l.useEffect)(()=>{w()},[t.query]);let g=(0,l.useRef)(null),{data:b}=(0,i.useQuery)(["GetUserInfo"],e=>{let{signal:t}=e;return s(t)},{enabled:!0,refetchOnMount:!1,refetchOnWindowFocus:!1});return(0,l.useEffect)(()=>{b&&h({field:"userInfo",value:{staffId:0,staffName:b.data.user,avatarUrl:"https://r.hrc.woa.com/photo/150/".concat(b.data.user,".png")}})},[b,h]),(0,l.useEffect)(()=>{(null==b?void 0:b.data.user)&&x&&x.title&&f&&"true"!==t.query.is_try&&O("visit_help_center",{user_name:null==b?void 0:b.data.user,visit_time:Date.now(),web_name:x.name,visit_id:"".concat(null==b?void 0:b.data.user,"_").concat(p),web_key:f})},[b,x,f]),(0,a.jsxs)(v.Provider,{value:{..._},children:[(0,a.jsxs)(c(),{children:[(0,a.jsx)("title",{children:"易事厅-AI PaaS"}),(0,a.jsx)("meta",{name:"description",content:"易事厅-AI PaaS"}),(0,a.jsx)("meta",{name:"viewport",content:"width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover"}),(0,a.jsx)("link",{rel:"icon",href:"/chat/logo.png"})]}),(0,a.jsx)("main",{className:"h-dvh w-screen overflow-hidden text-sm text-white",children:(0,a.jsx)(K,{stopConversationRef:g})})]})};var G=!0,V=J},8793:function(e){e.exports={colorful_border:"colorfulBorder_colorful_border___vdYt",animate:"colorfulBorder_animate__XhTGD",colorful_border_paused:"colorfulBorder_colorful_border_paused__ihVvK"}}}]);